name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.6.0
      - run: go build ./cmd/sc/
      - run: go test ./...
      - run: go vet ./...

  tag:
    needs: build
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump from commits since last tag
        id: bump
        run: |
          LATEST=$(git tag --list 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          # Scan all commits since last tag, pick the highest bump level
          BUMP=""
          while IFS= read -r -d '' COMMIT; do
            MSG=${COMMIT%%$'\n'*}
            if [[ "$COMMIT" == *$'\n'* ]]; then
              BODY=${COMMIT#*$'\n'}
            else
              BODY=""
            fi
            if echo "$MSG" | grep -qE '^.+!:' || echo "$BODY" | grep -qE '^BREAKING[ -]CHANGE:'; then
              BUMP="major"
              break  # Can't go higher
            elif echo "$MSG" | grep -qE '^feat(\(.+\))?:'; then
              [ "$BUMP" != "major" ] && BUMP="minor"
            elif echo "$MSG" | grep -qE '^(fix|perf|refactor)(\(.+\))?:'; then
              [ -z "$BUMP" ] && BUMP="patch"
            fi
          done < <(git log "${LATEST}..HEAD" --format='%s%n%b%x00')

          if [ -z "$BUMP" ]; then
            echo "No releasable commits since $LATEST"
            exit 0
          fi

          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)

          case "$BUMP" in
            major) NEXT="v$((MAJOR + 1)).0.0" ;;
            minor) NEXT="v${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "Latest tag: $LATEST"
          echo "Bump type: $BUMP"
          echo "Next tag: $NEXT"

          git tag "$NEXT"
          git push origin "$NEXT"
          echo "new_tag=$NEXT" >> "$GITHUB_OUTPUT"

  release:
    needs: tag
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler' && needs.tag.outputs.new_tag != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.tag.outputs.new_tag }}
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - name: Extract release notes from CHANGELOG.md
        run: |
          TAG="${{ needs.tag.outputs.new_tag }}"
          VER="${TAG#v}"
          awk "/^## \\[v${VER}\\]/{found=1; next} /^## \\[v/{if(found) exit} found" CHANGELOG.md > /tmp/release-notes.md
          if [ ! -s /tmp/release-notes.md ]; then
            echo "Release ${TAG}" > /tmp/release-notes.md
          fi
      - uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean --release-notes=/tmp/release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ needs.tag.outputs.new_tag }}
