name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.6.0
      - run: go build ./cmd/sc/
      - run: go test ./...
      - run: go vet ./...

  tag:
    needs: build
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if release should be skipped
        id: check
        run: |
          MSG=$(git log -1 --format=%s)
          if echo "$MSG" | grep -qE '^(ci|chore|docs|style|test)(\(.+\))?:'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping release for: $MSG"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump minor version and tag
        if: steps.check.outputs.skip == 'false'
        id: bump
        run: |
          LATEST=$(git tag --list 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)

          NEXT="v${MAJOR}.$((MINOR + 1)).0"

          echo "Latest tag: $LATEST"
          echo "Next tag: $NEXT"

          git tag "$NEXT"
          git push origin "$NEXT"
          echo "new_tag=$NEXT" >> "$GITHUB_OUTPUT"

  release:
    needs: tag
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler' && needs.tag.outputs.new_tag != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.tag.outputs.new_tag }}
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - name: Extract release notes from CHANGELOG.md
        run: |
          TAG="${{ needs.tag.outputs.new_tag }}"
          VER="${TAG#v}"
          awk "/^## \\[v${VER}\\]/{found=1; next} /^## \\[v/{if(found) exit} found" CHANGELOG.md > /tmp/release-notes.md
          if [ ! -s /tmp/release-notes.md ]; then
            echo "Release ${TAG}" > /tmp/release-notes.md
          fi
      - uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean --release-notes=/tmp/release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ needs.tag.outputs.new_tag }}
